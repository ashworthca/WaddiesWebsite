<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Waddies - Admin</title>
  <script defer src="/__/firebase/10.8.0/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/10.8.0/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/10.8.0/firebase-database-compat.js"></script>
  <script defer src="/__/firebase/init.js?useEmulator=false"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin:0; background:#f5f5f7; color:#333; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; }
    a { color:#0070c9; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .panel { background:#fff; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); padding:1rem; margin-bottom:1rem; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
    .btn { background:#0070c9; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn.secondary { background:#455a64; }
    .btn.danger { background:#c62828; }
    .table { width:100%; border-collapse: collapse; font-size:0.95rem; }
    .table th, .table td { padding:8px; border-bottom:1px solid #eee; text-align:left; }
    .muted { color:#666; font-size:0.9rem; }
    .login { position:fixed; inset:0; background:#f5f5f7; display:flex; align-items:center; justify-content:center; }
    .login-card { background:#fff; padding:1.25rem; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.12); width:320px; }
    .login-card h2 { margin:0 0 0.75rem; }
    .field { display:flex; flex-direction:column; gap:4px; margin-bottom:0.75rem; }
    .field input { padding:8px; border:1px solid #ddd; border-radius:8px; }
    .error { color:#c00; font-size:0.9rem; }
    .badge { background:#eef2f7; color:#40576b; font-size:0.75rem; padding:2px 6px; border-radius:999px; }
    .list { max-height:320px; overflow:auto; border:1px solid #eee; border-radius:8px; }
  </style>
</head>
<body>
  <div id="login" class="login">
    <div class="login-card">
      <h2>Admin Login</h2>
      <div class="field"><label>Username</label><input id="user" autocomplete="username" /></div>
      <div class="field"><label>Password</label><input id="pass" type="password" autocomplete="current-password" /></div>
      <button class="btn" id="loginBtn">Sign in</button>
      <div class="error" id="loginErr" style="display:none;">Invalid credentials</div>
      <div class="muted" style="margin-top:6px;">This page performs admin operations. Ensure you have appropriate database permissions.</div>
    </div>
  </div>

  <div class="container" id="app" style="display:none;">
    <div class="header">
      <h1>Admin Tools</h1>
      <div class="muted"><a href="index.html">Home</a> · <a href="stats.html">Stats</a></div>
    </div>

    <div class="panel">
      <h3>Scan for Orphans</h3>
      <div class="muted">Find records with missing counterparts (e.g., games referencing unknown players, player-rounds for missing players/games).</div>
      <div style="margin:8px 0; display:flex; gap:8px;">
        <button class="btn" id="scanBtn">Scan Database</button>
      </div>
      <div class="grid">
        <div>
          <h4>Orphan Players <span class="badge" id="orphanPlayersCount">0</span></h4>
          <div class="list"><table class="table" id="orphanPlayers"><thead><tr><th>playerId</th><th>Name</th><th>Reason</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div>
          <h4>Orphan Games <span class="badge" id="orphanGamesCount">0</span></h4>
          <div class="list"><table class="table" id="orphanGames"><thead><tr><th>gameId</th><th>Issue</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div>
          <h4>Orphan Player-Rounds <span class="badge" id="orphanRoundsCount">0</span></h4>
          <div class="list"><table class="table" id="orphanRounds"><thead><tr><th>playerId</th><th>gameId</th><th>Issue</th></tr></thead><tbody></tbody></table></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Players</h3>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; max-width:560px;">
        <input id="playerSearch" placeholder="Search name or id" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:8px;" />
        <button class="btn secondary" id="playersRefresh">Refresh</button>
      </div>
      <div class="grid" style="grid-template-columns: 320px 1fr;">
        <div>
          <div class="list">
            <table class="table" id="playersTable">
              <thead><tr><th>Player</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="muted" id="playerHeader">Select a player to view details</div>
          <h4 style="display:flex; align-items:center; gap:10px;">
            <span>Games <span class="badge" id="playerGamesCount">0</span></span>
            <button class="btn danger" id="deleteAllGamesBtn" title="Delete all games this player participated in">Delete All</button>
          </h4>
          <div class="list" style="margin-bottom:10px;">
            <table class="table" id="playerGames">
              <thead><tr><th>Date</th><th>Match</th><th>Score</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <h4>Player-Rounds <span class="badge" id="playerRoundsCount">0</span></h4>
          <div class="list">
            <table class="table" id="playerRoundsTable">
              <thead><tr><th>Game</th><th>Team</th><th>Score</th><th>Win</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Delete Player and Data</h3>
      <div class="muted">Removes the player record, their player-rounds, and optionally scrubs their ID from games’ team player lists.</div>
      <div class="field" style="max-width:480px;"><label>Player ID</label><input id="delPid" placeholder="playerId (email-hash/UUID)" /></div>
      <div style="display:flex; gap:8px; align-items:center; margin:8px 0;">
        <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" id="scrubGames"> Scrub from games’ team players</label>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn danger" id="deleteBtn">Delete Player</button>
        <div class="muted" id="deleteResult"></div>
      </div>
    </div>
  </div>

  <script>
    // Simple auth: username=admin, password must match sha256('waddies4fun')
    async function sha256Hex(str){
      const enc = new TextEncoder();
      const digest = await crypto.subtle.digest('SHA-256', enc.encode(str));
      return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function expectedHash(){
      // Hard-coded derivation of the expected hash
      return await sha256Hex('waddies4fun');
    }

    const ADMIN_EMAIL = 'admin@waddies.app'; // Ensure this user exists in Firebase Auth (Email/Password)
    document.getElementById('loginBtn').onclick = async () => {
      const u = document.getElementById('user').value.trim();
      const p = document.getElementById('pass').value;
      const okUser = (u === 'admin');
      const okPass = (await sha256Hex(p)) === (await expectedHash());
      if (okUser && okPass){
        try {
          // Sign in to satisfy RTDB rules that require auth != null
          await firebase.auth().signInWithEmailAndPassword(ADMIN_EMAIL, p);
          document.getElementById('login').style.display = 'none';
          document.getElementById('app').style.display = 'block';
        } catch (e){
          // Fallback: try anonymous auth if enabled on the project
          try {
            await firebase.auth().signInAnonymously();
            document.getElementById('login').style.display = 'none';
            document.getElementById('app').style.display = 'block';
          } catch (e2){
            const err = document.getElementById('loginErr'); err.style.display='block'; err.textContent='Auth failed (enable Email/Password for '+ADMIN_EMAIL+' or Anonymous Sign-in).';
          }
        }
      } else {
        const err = document.getElementById('loginErr'); err.style.display='block'; err.textContent='Invalid credentials';
      }
    };

    const state = { players:{}, games:{}, playerRounds:{} };

    function el(id){ return document.getElementById(id); }
    function setCount(id, n){ el(id).textContent = String(n); }
    function row(tbody, cells){ const tr = document.createElement('tr'); cells.forEach(c=>{ const td=document.createElement('td'); td.innerHTML=c; tr.appendChild(td); }); tbody.appendChild(tr); }

    async function loadAll(){
      const db = firebase.database();
      const [pSnap, gSnap, prSnap] = await Promise.all([
        db.ref('/players').once('value'),
        db.ref('/games').once('value'),
        db.ref('/player-rounds').once('value')
      ]);
      state.players = pSnap.val() || {};
      state.games = gSnap.val() || {};
      state.playerRounds = prSnap.val() || {};
    }

    function buildPlayersList(){
      const tbody = document.querySelector('#playersTable tbody');
      const q = (document.getElementById('playerSearch').value || '').toLowerCase();
      const rows = Object.entries(state.players)
        .map(([pid, p]) => ({ pid, name: p?.name || '', idShort: pid.slice(0,6) }))
        .filter(x => !q || x.name.toLowerCase().includes(q) || x.pid.toLowerCase().includes(q))
        .sort((a,b) => a.name.localeCompare(b.name));
      tbody.innerHTML='';
      rows.forEach(x => {
        const tr = document.createElement('tr');
        tr.dataset.pid = x.pid;
        tr.innerHTML = `<td><strong>${x.name || '(unnamed)'}</strong><div class="muted">${x.idShort}</div></td>`;
        tr.onclick = () => renderPlayer(x.pid);
        tbody.appendChild(tr);
      });
    }

    function teamNames(game, key){
      const team = game?.teams?.[key]; if(!team) return '';
      const pMap = team.players || {};
      const entries = Object.entries(pMap);
      if (entries.length > 0){
        const names = entries.map(([pid, val]) => (val && typeof val === 'object' && val.name) ? val.name : (state.players[pid]?.name || pid.slice(0,6)));
        return names.join(' & ');
      }
      return team.name || '';
    }

    function renderPlayer(pid){
      const p = state.players[pid];
      document.getElementById('delPid').value = pid;
      document.getElementById('playerHeader').innerHTML = `<strong>${p?.name || '(unnamed)'} </strong><span class="muted">${pid}</span>`;

      // Games that include this player
      const gamesRows = [];
      Object.entries(state.games).forEach(([gid, g]) => {
        const t1Ids = Object.keys(g?.teams?.team1?.players || {});
        const t2Ids = Object.keys(g?.teams?.team2?.players || {});
        if (t1Ids.includes(pid) || t2Ids.includes(pid)){
          const date = g?.date ? new Date(g.date*1000).toLocaleString() : '';
          const match = `${teamNames(g,'team1')} vs ${teamNames(g,'team2')}`;
          const score = `${g?.teams?.team1?.score ?? ''} - ${g?.teams?.team2?.score ?? ''}`;
          gamesRows.push({ gid, date, match, score });
        }
      });
      const gt = document.querySelector('#playerGames tbody'); gt.innerHTML='';
      gamesRows.sort((a,b)=> (a.date>b.date? -1:1)).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.date}</td><td>${r.match}</td><td>${r.score}</td><td><button class=\"btn danger\" data-gid=\"${r.gid}\">Delete</button></td>`;
        tr.querySelector('button').onclick = () => deleteGameForPlayer(pid, r.gid);
        gt.appendChild(tr);
      });
      document.getElementById('playerGamesCount').textContent = String(gamesRows.length);

      // Player-rounds entries
      const prFor = state.playerRounds[pid] || {};
      const prRows = Object.entries(prFor).map(([gid, node])=>{
        const team = node?.meta?.teamName || '';
        const score = `${node?.meta?.teamScore ?? ''}-${node?.meta?.opponentScore ?? ''}`;
        const win = node?.meta?.isWin ? '✅' : '❌';
        return { gid, team, score, win };
      });
      const prt = document.querySelector('#playerRoundsTable tbody'); prt.innerHTML='';
      prRows.forEach(r => row(prt, [r.gid.slice(0,8)+'…', r.team, r.score, r.win]));
      document.getElementById('playerRoundsCount').textContent = String(prRows.length);
    }

    async function deleteGameForPlayer(pid, gid){
      if (!confirm(`Delete game ${gid} and this player's rounds?`)) return;
      try {
        const db = firebase.database();
        const updates = {};
        // delete the game entirely
        updates[`/games/${gid}`] = null;
        // delete player-rounds entries for all players involved in this game
        const involved = new Set();
        const g = state.games[gid];
        if (g){
          Object.keys(g?.teams?.team1?.players || {}).forEach(p=> involved.add(p));
          Object.keys(g?.teams?.team2?.players || {}).forEach(p=> involved.add(p));
        }
        // If not in state (fresh), at least delete the current player's node
        if (involved.size === 0) involved.add(pid);
        involved.forEach(p => { updates[`/player-rounds/${p}/${gid}`] = null; });

        await db.ref().update(updates);
        // Refresh local state and re-render
        await loadAll();
        renderPlayer(pid);
      } catch (e){
        alert('Delete game failed: ' + (e?.message || e));
      }
    }

    function scanOrphans(){
      const orphanPlayersT = el('orphanPlayers').querySelector('tbody'); orphanPlayersT.innerHTML='';
      const orphanGamesT   = el('orphanGames').querySelector('tbody');   orphanGamesT.innerHTML='';
      const orphanRoundsT  = el('orphanRounds').querySelector('tbody');  orphanRoundsT.innerHTML='';

      const players = state.players; const games = state.games; const pr = state.playerRounds;
      const playerIds = new Set(Object.keys(players));

      // Orphan player-rounds: playerId not in players, or gameId not in games
      let orphanRoundsCount = 0;
      Object.entries(pr).forEach(([pid, gamesObj])=>{
        const pidExists = playerIds.has(pid);
        Object.keys(gamesObj||{}).forEach(gid => {
          const gameExists = !!games[gid];
          if (!pidExists || !gameExists){
            row(orphanRoundsT, [pid, gid, !pidExists? 'player missing':'game missing']);
            orphanRoundsCount++;
          }
        });
      });

      // Orphan games: any team players not found in /players, or empty players listing
      let orphanGamesCount = 0;
      Object.entries(games).forEach(([gid, g])=>{
        const t1 = Object.keys(g?.teams?.team1?.players || {});
        const t2 = Object.keys(g?.teams?.team2?.players || {});
        const all = [...t1, ...t2];
        const missing = all.filter(pid => !playerIds.has(pid));
        if (all.length === 0 || missing.length > 0){
          const issue = all.length === 0 ? 'no team players' : `missing players: ${missing.map(x=>players[x]?.name||x).join(', ')}`;
          row(orphanGamesT, [gid, issue]); orphanGamesCount++;
        }
      });

      // Orphan players: not referenced in games or player-rounds
      let orphanPlayersCount = 0;
      const referenced = new Set();
      Object.values(games).forEach(g=>{
        Object.keys(g?.teams?.team1?.players || {}).forEach(pid=>referenced.add(pid));
        Object.keys(g?.teams?.team2?.players || {}).forEach(pid=>referenced.add(pid));
      });
      Object.keys(pr).forEach(pid=>referenced.add(pid));
      Object.entries(players).forEach(([pid, p])=>{
        if (!referenced.has(pid)){
          row(orphanPlayersT, [pid, p?.name || '', 'not referenced']); orphanPlayersCount++;
        }
      });

      setCount('orphanPlayersCount', orphanPlayersCount);
      setCount('orphanGamesCount', orphanGamesCount);
      setCount('orphanRoundsCount', orphanRoundsCount);
    }

    async function deletePlayerCascade(pid, scrub){
      const db = firebase.database();
      const updates = {};
      // remove player record
      updates[`/players/${pid}`] = null;
      // remove player-rounds subtree
      updates[`/player-rounds/${pid}`] = null;
      if (scrub){
        // remove from each game's team players (set to null)
        Object.entries(state.games).forEach(([gid, g])=>{
          if (g?.teams?.team1?.players && g.teams.team1.players[pid] !== undefined){
            updates[`/games/${gid}/teams/team1/players/${pid}`] = null;
          }
          if (g?.teams?.team2?.players && g.teams.team2.players[pid] !== undefined){
            updates[`/games/${gid}/teams/team2/players/${pid}`] = null;
          }
        });
      }
      await db.ref().update(updates);
    }

    el('scanBtn').onclick = async () => {
      try {
        await loadAll();
        scanOrphans();
        buildPlayersList();
      } catch (e){
        alert('Scan failed: ' + (e?.message || e));
      }
    };

    el('deleteBtn').onclick = async () => {
      const pid = el('delPid').value.trim(); const scrub = el('scrubGames').checked;
      if (!pid) { el('deleteResult').textContent = 'Enter a playerId'; return; }
      if (!confirm(`Delete player ${pid} and their data? This cannot be undone.`)) return;
      try {
        // Reload games to have current for scrubbing
        await loadAll();
        await deletePlayerCascade(pid, scrub);
        el('deleteResult').textContent = 'Delete requested. If rules block writes, adjust permissions.';
        // Refresh lists
        await loadAll();
        buildPlayersList();
      } catch (e){
        el('deleteResult').textContent = 'Delete failed: ' + (e?.message || e);
      }
    };

    // Players list interactions
    document.getElementById('playersRefresh').onclick = async () => {
      try { await loadAll(); buildPlayersList(); } catch(e){ alert('Refresh failed: '+(e?.message||e)); }
    };
    document.getElementById('playerSearch').oninput = () => buildPlayersList();

    // Initialize players after login automatically
    (async function initAfterLogin(){
      // Wait a tick for login to complete
      setTimeout(async () => { try { await loadAll(); buildPlayersList(); } catch(_){} }, 500);
    })();
  </script>
</body>
</html>

