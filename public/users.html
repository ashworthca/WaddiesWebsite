<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Waddies - Player Details</title>
  <script defer src="/__/firebase/10.8.0/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/10.8.0/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/10.8.0/firebase-database-compat.js"></script>
  <script defer src="/__/firebase/init.js?useEmulator=false"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin:0; background:#f5f5f7; color:#333; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; }
    .layout { display:grid; grid-template-columns: 360px 1fr; gap: 1rem; }
    .panel { background:#fff; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); padding:1rem; }
    .game-list { list-style:none; padding:0; margin:0; max-height:70vh; overflow:auto; }
    .game-item { padding:0.75rem 0.9rem; border-bottom:1px solid #eee; cursor:pointer; }
    .game-item:hover, .game-item.active { background:#f0f6ff; }
    .game-row { display:flex; flex-direction:column; gap:8px; }
    .row-header { display:flex; gap:8px; align-items:center; color:#666; font-size:0.85rem; flex-wrap:wrap; }
    .badge { background:#eef2f7; color:#40576b; font-size:0.75rem; padding:2px 6px; border-radius:999px; }
    .badge-type { background:#e8f3ff; color:#0b5cab; }
    .badge-warn { background:#fff4e5; color:#8a5a00; }
    .icon { opacity:0.8; }
    .row-main { display:grid; grid-template-columns: 1fr 56px 1fr; gap:16px; align-items:center; }
    .team { display:grid; grid-template-rows: auto auto auto; row-gap:2px; }
    .team .name { font-weight:700; color:#1a1a1a; line-height:1.2; }
    .team .players { font-size:0.85rem; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .team .sub { font-size:0.9rem; color:#40576b; }
    .team.my .name { font-weight:800; }
    .vs { display:flex; align-items:center; justify-content:center; color:#888; font-weight:700; }
    .winner { color:#0a7d33; font-size:0.85rem; }
    /* Round rows */
    .round-row { padding:10px 12px; border-bottom:1px solid #eee; border-radius:8px; }
    .round-row.scored-left { background: #f3fff6; }
    .round-row.scored-right { background: #f3fff6; }
    .round-row .top { display:grid; grid-template-columns: 1fr 120px 1fr; align-items:center; column-gap:12px; }
    .score { display:grid; grid-auto-flow:column; grid-auto-columns:min-content; gap:6px; align-items:center; }
    .score .total { font-weight:700; }
    .score .delta.scored { color:#0a7d33; font-weight:700; }
    .round-center { display:grid; justify-items:center; }
    .round-center .num { font-weight:700; }
    .round-center .duration { font-size:0.8rem; color:#666; }
    .bottom { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:6px; font-size:0.9rem; color:#444; align-items:center; }
    .bottom .star { color:#f5a623; margin-right:4px; }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace; }
    .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:0.75rem; }
    .stat-card { background:#f8f9fa; border-radius:8px; padding:0.75rem; text-align:center; }
    .stat-value { font-weight:700; font-size:1.2rem; color:#0070c9; }
    .muted { color:#666; font-size:0.9rem; }
    .footer { text-align:center; margin-top:1rem; }
    a { color:#0070c9; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .toolbar { display:flex; gap:0.5rem; align-items:center; margin-bottom:0.75rem; }
    .section-title { font-weight:700; color:#1a1a1a; margin:0 0 0.5rem; }
    .divider { height:1px; background:#eee; margin:0.5rem 0 0.5rem; }
    select { padding:0.4rem 0.5rem; border:1px solid #ddd; border-radius:6px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="playerName">Player</h1>
      <div class="muted"><a href="index.html">Home</a> ¬∑ <a href="stats.html">Stats</a></div>
    </div>

    <!-- Overall stats area -->
    <div class="panel" style="margin-bottom:1rem;">
      <div id="overallTitle" class="section-title">Overall Stats</div>
      <div id="playerStats" class="stats-grid"></div>
    </div>

    <!-- Games + Details area -->
    <div class="layout">
      <div class="panel">
        <div class="section-title">Games</div>
        <div class="toolbar">
          <label for="levelFilter">Filter:</label>
          <select id="levelFilter">
            <option value="all">All</option>
            <option value="standard">Standard</option>
            <option value="pro">Pro</option>
            <option value="tourney">Tourney</option>
          </select>
        </div>
        <ul id="gameList" class="game-list"></ul>
      </div>
      <div class="panel">
        <div class="section-title">Game Details</div>
        <div id="gameHeader" class="muted" style="margin:0.25rem 0 0.5rem;"></div>
        <div id="rounds"></div>
      </div>
    </div>

    <div class="footer muted">Support: <a href="mailto:waddiesapp@gmail.com">waddiesapp@gmail.com</a></div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const playerId = qs.get('pid');
    let players = {}; let games = {}; let playerRounds = {};

    function el(id){ return document.getElementById(id); }

    function getGameById(id){ return games[id] || null; }
    function roundsArr(game){ const rs = game?.rounds || []; return Array.isArray(rs)? rs : Object.values(rs); }
    function teamInfo(pid, game){
      const t1 = Object.keys(game?.teams?.team1?.players || {});
      const t2 = Object.keys(game?.teams?.team2?.players || {});
      if (t1.includes(pid)) return { teamId: game.teams.team1.id, idx:1 };
      if (t2.includes(pid)) return { teamId: game.teams.team2.id, idx:2 };
      return { teamId:null, idx:null };
    }
    function teamNames(game, key){
      const team = game?.teams?.[key]; if(!team) return '';
      const pMap = team.players || {};
      const entries = Object.entries(pMap);
      if (entries.length > 0){
        const names = entries.map(([pid, val]) => {
          if (val && typeof val === 'object' && val.name) return val.name;
          const n = players[pid]?.name;
          return n || pid.substring(0,6);
        }).filter(Boolean);
        return names.join(' & ');
      }
      return team.name || '';
    }
    function teamPlayersList(game, key){
      const team = game?.teams?.[key]; if(!team) return '';
      const pMap = team.players || {};
      const entries = Object.entries(pMap);
      if (entries.length > 0){
        const names = entries.map(([pid, val]) => {
          if (val && typeof val === 'object' && val.name) return val.name;
          const n = players[pid]?.name; return n || pid.substring(0,6);
        });
        return names.join(', ');
      }
      return '';
    }
    function prettyMatchup(pid, game){
      const { teamId, idx } = teamInfo(pid, game);
      const mineKey = idx===1? 'team1':'team2';
      const oppKey  = idx===1? 'team2':'team1';
      const myNames  = teamNames(game, mineKey);
      const oppNames = teamNames(game, oppKey);
      const myScore  = game?.teams?.[mineKey]?.score ?? '';
      const oppScore = game?.teams?.[oppKey]?.score ?? '';
      return { title: `${myNames} vs ${oppNames}`, score: `${myScore}-${oppScore}` };
    }
    function hammerSeries(game){
      const rs = roundsArr(game); const t1 = game?.teams?.team1?.id; const t2 = game?.teams?.team2?.id; if(!t1||!t2) return [];
      const sim = (h)=>{ let cur=h, out=[]; for(const r of rs){ const pts=Number(r?.pointsScored||0), s=r?.scoringTeam||null; if(pts===0 && s && s!==cur) return null; out.push(cur); cur = (pts>0&&s)? s : (cur===t1?t2:t1);} return out; };
      return sim(t1) || sim(t2) || [];
    }

    function attributeForGame(pid, entry){
      const game = getGameById(entry.gameId); const gameRs = roundsArr(game); const { teamId, idx } = teamInfo(pid, game);
      let points=0, tossed=0, scoringRounds=0, best=0;
      for(const r of (entry.rounds||[])){
        const rn=r.roundNumber||0; const gr = gameRs.find(x=> (x?.roundNumber||0)===rn) || gameRs[rn-1] || null; if(!gr) continue;
        const iTossed = idx===1 ? gr.team1TosserId===pid : gr.team2TosserId===pid;
        if(!iTossed) continue; tossed++;
        const per = Number(r.score||0); const teamScored = Number(gr.pointsScored||0)>0 && gr.scoringTeam===teamId;
        const attributed = per>0 ? per : (teamScored ? Number(gr.pointsScored||0):0);
        if(attributed>0){ scoringRounds++; best=Math.max(best, attributed); }
        points += attributed;
      }
      return { points, tossed, scoringRounds, best };
    }

    function drawStats(pid){
      const entries = Object.entries(playerRounds[pid]||{}).map(([gameId, node])=>({gameId, meta:node.meta||{}, rounds:Object.values(node.rounds||{}).filter(Boolean)}));
      const level = el('levelFilter').value;
      const label = level==='standard' ? 'Standard' : (level==='pro' ? 'Pro' : (level==='tourney' ? 'Tourney' : 'All'));
      el('overallTitle').textContent = `Overall Stats - ${label}`;
      const filtered = entries.filter(e=>{
        if(!(e.meta && e.meta.isValid)) return false;
        const g = games[e.gameId];
        const isPro = !!(g && g.scoringMode === 'teamAttempts');
        const isTourney = !!(g && g.tournamentId);
        if(level==='pro') return isPro;
        if(level==='tourney') return isTourney;
        if(level==='standard') return !(isPro || isTourney);
        return true;
      });
      // Aggregate
      let totalGames=filtered.length, wins=filtered.reduce((s,e)=> s+(e.meta.isWin?1:0),0), points=0, tossed=0, scoringR=0, best=0;
      for(const e of filtered){ const a=attributeForGame(pid,e); points+=a.points; tossed+=a.tossed; scoringR+=a.scoringRounds; best=Math.max(best,a.best); }
      const avg = tossed>0? (points/tossed):0; const winRate = totalGames>0? (wins/totalGames*100):0;
      el('playerStats').innerHTML = `
        <div class="stat-card"><div class="stat-value">${totalGames}</div><div class="muted">Games</div></div>
        <div class="stat-card"><div class="stat-value">${wins}</div><div class="muted">Wins</div></div>
        <div class="stat-card"><div class="stat-value">${winRate.toFixed(1)}%</div><div class="muted">Win Rate</div></div>
        <div class="stat-card"><div class="stat-value">${points}</div><div class="muted">Points</div></div>
        <div class="stat-card"><div class="stat-value">${avg.toFixed(1)}</div><div class="muted">Avg Pts/Round</div></div>
        <div class="stat-card"><div class="stat-value">${scoringR}</div><div class="muted">Scoring Rounds</div></div>
        <div class="stat-card"><div class="stat-value">${best}</div><div class="muted">Best Round</div></div>
      `;

      // Games list
      const list = el('gameList'); list.innerHTML='';
      filtered.sort((a,b)=> (games[b.gameId]?.date||0) - (games[a.gameId]?.date||0));
      for(const e of filtered){
        const g=games[e.gameId]; const when = g?.date? new Date(g.date*1000).toLocaleString():'';
        const li=document.createElement('li'); li.className='game-item'; li.dataset.gid=e.gameId;
        const pm = prettyMatchup(pid, g);
        const typeBadge = g?.gameType ? `<span class=\"badge badge-type\">${g.gameType}</span>` : '';
        const proIcon = g?.scoringMode === 'teamAttempts' ? `<span class=\"icon\" title=\"Pro Stats\">üìä</span>` : '';
        const trophy = g?.tournamentId ? `<span class=\"icon\" title=\"Tournament\">üèÜ</span>` : '';
        const excluded = (g?.noStats || g?.isDisputed) ? `<span class=\"badge badge-warn\">Excluded from Stats</span>` : '';
        const mineKey = teamInfo(pid, g).idx===1? 'team1':'team2';
        const t1Players = teamPlayersList(g,'team1');
        const t2Players = teamPlayersList(g,'team2');
        li.innerHTML = `
          <div class=\"game-row\">
            <div class=\"row-header\">${typeBadge}<span class=\"date\">${when}</span>${proIcon}${trophy}${excluded}</div>
            <div class=\"row-main\">
              <div class=\"team left ${mineKey==='team1'?'my':''}\">
                <div class=\"name\">${teamNames(g,'team1') || 'Team 1'}</div>
                <div class=\"players\">${t1Players}</div>
                <div class=\"sub\"><span class=\"mono\">${g?.teams?.team1?.score ?? ''}</span> points</div>
              </div>
              <div class=\"vs\">VS</div>
              <div class=\"team right ${mineKey==='team2'?'my':''}\">
                <div class=\"name\">${teamNames(g,'team2') || 'Team 2'}</div>
                <div class=\"players\">${t2Players}</div>
                <div class=\"sub\"><span class=\"mono\">${g?.teams?.team2?.score ?? ''}</span> points</div>
              </div>
            </div>
            ${g?.winner?.players ? `<div class=\"winner\">Winners: ${Object.keys(g.winner.players).map(id=> players[id]?.name || id.substring(0,6)).join(', ')}</div>`:''}
          </div>`;
        li.onclick=()=> { document.querySelectorAll('.game-item').forEach(n=>n.classList.remove('active')); li.classList.add('active'); showGame(pid, e); };
        list.appendChild(li);
      }
      if(filtered[0]) showGame(pid, filtered[0]);
    }

    function showGame(pid, entry){
      const g = games[entry.gameId]; const rs = roundsArr(g);
      const pm = prettyMatchup(pid, g);
      // build richer header with named teams
      el('gameHeader').innerHTML = `<strong>${pm.title}</strong> <span class="badge">${pm.score}</span> ¬∑ ${new Date((g?.date||0)*1000).toLocaleString()}`;
      const roundsDiv = el('rounds'); roundsDiv.innerHTML='';
      // join by roundNumber and render
      let prevTs = null;
      for(const r of entry.rounds){
        const rn=r.roundNumber||0; const gr = rs.find(x=> (x?.roundNumber||0)===rn) || rs[rn-1] || null; if(!gr) continue;
        const t1Score = Number(gr.team1Score||0);
        const t2Score = Number(gr.team2Score||0);
        const pts = Number(gr.pointsScored||0);
        const scoredLeft = pts>0 && gr.scoringTeam === g?.teams?.team1?.id;
        const scoredRight= pts>0 && gr.scoringTeam === g?.teams?.team2?.id;
        const row = document.createElement('div'); row.className = `round-row ${scoredLeft?'scored-left': (scoredRight?'scored-right':'')}`;
        const t1Tosser = gr.team1TosserName || (players[gr.team1TosserId]?.name) || '';
        const t2Tosser = gr.team2TosserName || (players[gr.team2TosserId]?.name) || '';
        const showTossers = (g?.gameType || '') !== '1v1';
        const deltaLeft = scoredLeft? ` <span class=\"delta scored\">+${pts}</span>`:'';
        const deltaRight= scoredRight? ` <span class=\"delta scored\">+${pts}</span>`:'';
        const ts = Number(r.timestamp || gr.timestamp || 0);
        const dur = (prevTs && ts)? Math.max(0, ts - prevTs): 0; prevTs = ts; const m = Math.floor(dur/60), s = Math.floor(dur%60).toString().padStart(2,'0');
        const switchIcon = pts===0 ? '‚Üî' : '';
        row.innerHTML = `
          <div class=\"top\">
            <div class=\"score left\">${showTossers && t1Tosser? `<span class=\\\"tosser\\\">${t1Tosser} -</span>`:''}<span class=\"total\">${t1Score}</span>${deltaLeft}</div>
            <div class=\"round-center\"><div class=\"num\">${switchIcon || rn}</div><div class=\"duration mono\">${m}:${s}</div></div>
            <div class=\"score right\">${deltaRight}<span class=\"total\">${t2Score}</span>${showTossers && t2Tosser? `<span class=\\\"tosser\\\">- ${t2Tosser}</span>`:''}</div>
          </div>`;
        const bottom = document.createElement('div');
        const isPro = g?.scoringMode === 'teamAttempts';
        if (isPro) {
          bottom.className = 'bottom pro-stats';
          const t1h = gr.team1AttemptsRaw?.holed ?? 0, t1b = gr.team1AttemptsRaw?.onBoard ?? 0;
          const t2h = gr.team2AttemptsRaw?.holed ?? 0, t2b = gr.team2AttemptsRaw?.onBoard ?? 0;
          bottom.innerHTML = `
            <div class=\"attempts left\">${scoredLeft? '<span class=\\\"star\\\">‚òÖ</span> ':''}${t1Tosser ? `${t1Tosser} ‚Äî ` : ''}${t1h} holed, ${t1b} board</div>
            <div class=\"attempts right\">${scoredRight? '<span class=\\\"star\\\">‚òÖ</span> ':''}${t2Tosser ? `${t2Tosser} ‚Äî ` : ''}${t2h} holed, ${t2b} board</div>
          `;
        } else {
          bottom.className = 'bottom standard';
          const holedCount = gr.waddieStats ? Object.values(gr.waddieStats).filter(ws=>ws?.holed).length : 0;
          const centerText = pts===0 ? 'Switch' : (holedCount>0 ? `${holedCount} Holed` : 'Board');
          bottom.innerHTML = `<div class=\"left\">${scoredLeft? '<span class=\\\"star\\\">‚òÖ</span>':''} ${showTossers && t1Tosser? t1Tosser:''}</div><div class=\"center\">${centerText}</div><div class=\"right\">${showTossers && t2Tosser? t2Tosser:''} ${scoredRight? '<span class=\\\"star\\\">‚òÖ</span>':''}</div>`;
        }
        row.appendChild(bottom);
        roundsDiv.appendChild(row);
      }
    }

    async function load(){
      const app = firebase.app();
      if (!app.options.databaseURL) { app.options.databaseURL = 'https://waddies-default-rtdb.firebaseio.com'; }
      try { await firebase.auth().signInAnonymously(); } catch (e) { console.warn('Anonymous sign-in failed:', e?.code || e?.message); }
      const db=firebase.database();
      const pSnap = await db.ref('/players').once('value'); players = pSnap.val()||{}; el('playerName').textContent = players[playerId]?.name || 'Player';
      // load player-rounds and deduce game ids
      const prSnap = await db.ref(`/player-rounds/${playerId}`).once('value'); playerRounds[playerId]= prSnap.val()||{};
      const gameIds = Object.keys(playerRounds[playerId]||{});
      // load games by id
      games={}; await Promise.all(gameIds.map(async id=>{ const gs=await db.ref(`/games/${id}`).once('value'); if(gs.exists()) games[id]=gs.val(); }));
      drawStats(playerId);
      el('levelFilter').onchange=()=> drawStats(playerId);
    }

    document.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>

